using UnityEngine;
using System.Collections;
using UnityEngine.UI.Windows;
using UnityEngine.UI;
using UnityEngine.Events;
using System;
using UnityEngine.UI.Windows.Components.Events;
using UnityEngine.EventSystems;
using UnityEngine.UI.Windows.Extensions;

namespace UnityEngine.UI.Windows.Components {

	public class ButtonComponent : ColoredComponent, ISelectable, IImageComponent, ITextComponent, IEventSystemHandler, IPointerEnterHandler, IPointerExitHandler {
		
		public override void Setup(IComponentParameters parameters) {
			
			base.Setup(parameters);
			
			var inputParameters = parameters as ButtonComponentParameters;
			{
				if (inputParameters != null) inputParameters.Setup(this as ISelectable);
			}

			#region macros UI.Windows.Initialization.TextComponent 
	/*
	 * This code is auto-generated by Macros Module
	 * Do not change anything
	 */
	{
					if (inputParameters != null) inputParameters.Setup(this as ITextComponent);
				}
	#endregion

			#region macros UI.Windows.Initialization.ImageComponent 
	/*
	 * This code is auto-generated by Macros Module
	 * Do not change anything
	 */
	{
					if (inputParameters != null) inputParameters.Setup(this as IImageComponent);
					
					if (this.playOnStart == true) {
						
						this.Play(this.loop);
						
					}
	
				}
	#endregion

		}

		#region WindowComponent events
		public override void OnDeinit() {
			
			base.OnDeinit();

			this.onState = null;
			this.onStateActive = false;
			
			if (this.button != null) this.button.onClick.RemoveListener(this.OnClick);
			this.callback.RemoveAllListeners();
			this.callbackButton.RemoveAllListeners();
			this.onHover.RemoveAllListeners();

		}
		
		public override void OnShowBegin(System.Action callback, bool resetAnimation = true) {
			
			base.OnShowBegin(callback, resetAnimation);
			
			this.onStateActive = true;
			
		}
		
		public override void OnHideEnd() {
			
			base.OnHideEnd();
			
			this.onStateActive = false;
			
		}

		public override void OnHideBegin(System.Action callback, bool immediately = false) {
			
			base.OnHideBegin(callback, immediately);
			
			this.OnPointerExit(null);
			
		}
		#endregion

		#region Button Base
		[Header("Button Component")]
		[SerializeField]
		protected Button button;

		public ComponentEvent callback = new ComponentEvent();
		private ComponentEvent<ButtonComponent> callbackButton = new ComponentEvent<ButtonComponent>();

		private System.Func<bool> onState;
		private bool oldState = false;
		private bool onStateActive = false;

		public virtual Selectable GetSelectable() {
			
			return this.button;
			
		}

		public void SetEnabledState(System.Func<bool> onState) {

			this.onState = onState;
			this.oldState = this.onState();
			this.onStateActive = true;

		}

		public virtual void LateUpdate() {

			if (this.onStateActive == true && this.onState != null) {

				var newState = this.onState();
				if (newState != this.oldState) this.SetEnabledState(newState);
				this.oldState = newState;

			}

		}

		public virtual void SetEnabledState(bool state) {

			if (state == true) {

				this.SetEnabled();

			} else {

				this.SetDisabled();

			}

		}

		public virtual void SetDisabled() {
		
			if (this.button != null) this.button.interactable = false;

		}

		public virtual void SetEnabled() {
			
			if (this.button != null) this.button.interactable = true;

		}

		public void Select() {

			this.button.interactable = false;

		}

		public void Deselect() {

			this.button.interactable = true;

		}
		
		public virtual void SetButtonColor(Color color) {

			if (this.button != null) {

				this.button.targetGraphic.color = color;

			}

		}

		public virtual void SetCallback(UnityAction callback) {

            this.callback.RemoveAllListeners();
            this.callback.AddListenerDistinct(callback);
			this.callbackButton.RemoveAllListeners();

			this.button.onClick.RemoveListener(this.OnClick);
			this.button.onClick.AddListener(this.OnClick);

		}
		
		public virtual void AddCallback(UnityAction callback) {
			
			this.callback.AddListenerDistinct(callback);
			this.button.onClick.RemoveListener(this.OnClick);
			this.button.onClick.AddListener(this.OnClick);
			
		}

		public virtual void SetCallback(UnityAction<ButtonComponent> callback) {

            this.callbackButton.RemoveAllListeners();
            this.callbackButton.AddListenerDistinct(callback);
			this.callback.RemoveAllListeners();

            this.button.onClick.RemoveAllListeners();
            // this.button.onClick.RemoveListener(this.OnClick);
			this.button.onClick.AddListener(this.OnClick);
			
		}
		
		public virtual void AddCallback(UnityAction<ButtonComponent> callback) {
			
			this.callbackButton.AddListenerDistinct(callback);
			this.button.onClick.RemoveListener(this.OnClick);
			this.button.onClick.AddListener(this.OnClick);
			
		}

		public virtual void OnClick() {

			if (this.GetWindow().GetState() != WindowObjectState.Shown &&
			    this.GetWindow().GetState() != WindowObjectState.Showing) {

				#if UNITY_EDITOR || DEBUGBUILD
				Debug.LogWarningFormat("Can't send click on `{0}` state. Be sure `{1}` window has the `Shown` or `Showing` state.", this.GetWindow().GetState(), this.GetWindow().name);
				#endif
				return;

			}

			this.sfxOnClick.Play();

			if (this.callback != null) this.callback.Invoke();
			if (this.callbackButton != null) this.callbackButton.Invoke(this);

		}
		#endregion

		#region Audio
		[Header("Audio")]
		[SerializeField]
		private Audio.Component sfxOnClick = new Audio.Component();
		[SerializeField]
		private Audio.Component sfxOnEnter = new Audio.Component();
		[SerializeField]
		private Audio.Component sfxOnLeave = new Audio.Component();

		public void SetSFX(PointerEventState state, Audio.Component data) {

			if (state == PointerEventState.Click) {

				this.sfxOnClick = data;

			} else if (state == PointerEventState.Enter) {

				this.sfxOnEnter = data;

			} else if (state == PointerEventState.Leave) {

				this.sfxOnLeave = data;

			}

		}
		#endregion

		#region Hover
		[Header("Hover Actions")]
		[SerializeField]
		private bool hoverIsActive = true;
		[SerializeField]
		private bool hoverOnAnyPointerState = false;
		[SerializeField]
		private bool hoverOnAnyButtonState = false;
		public ComponentEvent<bool> onHover = new ComponentEvent<bool>();

		[HideInInspector]
		private bool tempHoverState = false;

		public void SetHoverState(bool state) {
			
			this.hoverIsActive = state;
			
		}
		
		public void SetHoverOnAnyPointerState(bool state) {
			
			this.hoverOnAnyPointerState = state;
			
		}
		
		public void SetHoverOnAnyButtonState(bool state) {
			
			this.hoverOnAnyButtonState = state;
			
		}

		public virtual void SetCallbackHover(UnityAction<bool> onHover) {
			
			this.onHover.AddListenerDistinct(onHover);
			
		}

		private bool ValidateHoverPointer(PointerEventData eventData) {

			if (this.hoverIsActive == false) return false;
			if (this.button != null && this.hoverOnAnyButtonState == false && this.button.interactable == false) return false;
			if (this.hoverOnAnyPointerState == false && WindowSystemInput.GetPointerState() != PointerState.Default) return false;

			return true;

		}

		public void OnPointerEnter(PointerEventData eventData) {
			
			this.tempHoverState = false;

			if (this.ValidateHoverPointer(eventData) == false) return;
			
			this.sfxOnEnter.Play();

			this.tempHoverState = true;
			this.onHover.Invoke(true);
			
		}
		
		public void OnPointerExit(PointerEventData eventData) {

			if (this.tempHoverState == false) return;
			
			this.sfxOnLeave.Play();

			this.onHover.Invoke(false);
			
			this.tempHoverState = false;

		}

		#endregion

		#region macros UI.Windows.ImageComponent (overrideColor:override)

	/*
	 * This code is auto-generated by Macros Module
	 * Do not change anything
	 */
	[Header("Image Component")]
			[SerializeField]
			private bool preserveAspect;
	
			[SerializeField]
			private Image image;
			
			[SerializeField]
			private RawImage rawImage;
	
			[ReadOnly("rawImage", null)]
			[SerializeField]
			private  bool playOnStart;
			[ReadOnly("rawImage", null)]
			[SerializeField]
			private  bool loop;
	
			public void SetPlayOnStart(bool state) {
	
				this.playOnStart = state;
	
			}
	
			public void SetLoop(bool state) {
	
				this.loop = state;
	
			}
	
			public void SetPreserveAspectState(bool state) {
	
				this.preserveAspect = state;
	
			}
			
			public void Play() {
	
				this.Play(this.loop);
	
			}
	
			public void Play(bool loop) {
	
				var image = this.GetRawImageSource();
				if (image == null) return;
	
				var movie = image.mainTexture as MovieTexture;
				if (movie != null) {
					
					movie.loop = loop;
					movie.Play();
	
				}
	
			}
	
			public void Stop() {
				
				var image = this.GetRawImageSource();
				if (image == null) return;
				
				var movie = image.mainTexture as MovieTexture;
				if (movie != null) movie.Stop();
	
			}
	
			public void Pause() {
				
				var image = this.GetRawImageSource();
				if (image == null) return;
				
				var movie = image.mainTexture as MovieTexture;
				if (movie != null) movie.Pause();
	
			}
	
			public void ResetImage() {
				
				if (this.image != null) {
					
					this.image.sprite = null;
					
				}
				
				if (this.rawImage != null) {
					
					this.rawImage.texture = null;
					
				}
				
			}
			
			public Image GetImageSource() {
				
				return this.image;
				
			}
			
			public RawImage GetRawImageSource() {
				
				return this.rawImage;
				
			}
			
			public void SetImage(ImageComponent source) {
				
				if (source.GetImageSource() != null) this.SetImage(source.GetImageSource().sprite);
				if (source.GetRawImageSource() != null) this.SetImage(source.GetRawImageSource().texture);
				
			}
	
			public void SetImage(Sprite sprite, bool withPivotsAndSize = false) {
	
				this.SetImage(sprite, this.preserveAspect, withPivotsAndSize);
	
			}
	
			public void SetImage(Sprite sprite, bool preserveAspect, bool withPivotsAndSize = false) {
				
				if (this.image != null) {
	
					this.image.sprite = sprite;
					this.image.preserveAspect = preserveAspect;
	
					if (withPivotsAndSize == true && sprite != null) {
	
						var rect = (this.transform as RectTransform);
	
						rect.sizeDelta = sprite.rect.size;
						rect.pivot = sprite.GetPivot();
						rect.anchoredPosition = Vector2.zero;
	
					}
	
				}
				
			}
	
			public void SetImage(Texture texture) {
	
				this.SetImage(texture, this.preserveAspect);
	
			}
	
			public void SetImage(Texture texture, bool preserveAspect) {
				
				if (this.rawImage != null) {
	
					this.rawImage.texture = texture;
					if (this.preserveAspect == true) ME.Utilities.PreserveAspect(this.rawImage);
	
				}
				
			}
			
			public override Color GetColor() {
				
				Color color = Color.white;
				if (this.image != null) {
					
					color = this.image.color;
					
				} else if (this.rawImage != null) {
					
					color = this.rawImage.color;
					
				}
	
				return color;
	
			}
	
			public override void SetColor(Color color) {
	
				if (this.image != null) {
					
					this.image.color = color;
					
				} else if (this.rawImage != null) {
					
					this.rawImage.color = color;
					
				}
	
			}
	
			public void SetAlpha(float value) {
	
				var color = this.GetColor();
				color.a = value;
				this.SetColor(color);
	
			}
	
			public void SetMaterial(Material material) {
	
				if (this.image != null) {
	
					this.image.material = material;
					this.image.SetMaterialDirty();
	
				} else if (this.rawImage != null) {
	
					this.rawImage.material = material;
					this.rawImage.SetMaterialDirty();
	
				}
	
			}
	#endregion

		#region macros UI.Windows.TextComponent 
	/*
	 * This code is auto-generated by Macros Module
	 * Do not change anything
	 */
	[Header("Text Component")]
			[SerializeField]
			private Text text;
			public UnityEngine.UI.Windows.Components.TextComponent.ValueFormat valueFormat;
	
			public void SetBestFit(bool state, int minSize = 10, int maxSize = 40) {
				
				if (this.text != null) {
					
					this.text.resizeTextForBestFit = state;
					this.text.resizeTextMinSize = minSize;
					this.text.resizeTextMaxSize = maxSize;
					
				}
				
			}
			
			public void SetBestFitState(bool state) {
				
				if (this.text != null) this.text.resizeTextForBestFit = state;
				
			}
			
			public void SetBestFitMinSize(int size) {
				
				if (this.text != null) this.text.resizeTextMinSize = size;
				
			}
			
			public void SetBestFitMaxSize(int size) {
				
				if (this.text != null) this.text.resizeTextMaxSize = size;
				
			}
	
			public void SetFont(Font font) {
				
				if (this.text != null) this.text.font = font;
				
			}
	
			public void SetFontSize(int fontSize) {
				
				if (this.text != null) this.text.fontSize = fontSize;
				
			}
	
			public void SetLineSpacing(float value) {
				
				if (this.text != null) this.text.lineSpacing = value;
				
			}
			
			public void SetRichText(bool state) {
				
				if (this.text != null) this.text.supportRichText = state;
				
			}
			
			public void SetFontStyle(FontStyle fontStyle) {
				
				if (this.text != null) this.text.fontStyle = fontStyle;
				
			}
			
			public float GetContentHeight(float heightPadding = 0f) {
				
				if (this.text == null) return 0f;
				
				return this.GetContentHeight(this.GetText(), heightPadding);
				
			}
			
			public float GetContentHeight(string text, float heightPadding = 0f) {
				
				if (this.text == null) return 0f;
				
				return this.GetContentHeight(text, (this.transform.root as RectTransform).rect.size) + heightPadding;
				
			}
	
			public float GetContentHeight(string text, Vector2 containerSize) {
	
				if (this.text == null) return 0f;
	
				var settings = this.text.GetGenerationSettings(containerSize);
				return this.text.cachedTextGenerator.GetPreferredHeight(text, settings);
	
			}
	
			public void SetValueFormat(UnityEngine.UI.Windows.Components.TextComponent.ValueFormat format) {
	
				this.valueFormat = format;
	
			}
			
			public void SetValue(long value) {
				
				this.SetValue(value, this.valueFormat);
				
			}
			
			public void SetValue(int value) {
				
				this.SetValue(value, this.valueFormat);
	
			}
	
			public void SetValue(long value, UnityEngine.UI.Windows.Components.TextComponent.ValueFormat format) {
				
				this.SetText(TextComponent.FormatValue(value, format));
				
			}
	
			public void SetValue(int value, UnityEngine.UI.Windows.Components.TextComponent.ValueFormat format) {
				
				this.SetText(TextComponent.FormatValue(value, format));
				
			}
	
			public void SetTextVerticalOverflow(VerticalWrapMode mode) {
				
				if (this.text != null) this.text.verticalOverflow = mode;
				
			}
			
			public void SetTextHorizontalOverflow(HorizontalWrapMode mode) {
				
				if (this.text != null) this.text.horizontalOverflow = mode;
				
			}
	
			public void SetTextAlignment(TextAnchor anchor) {
				
				if (this.text != null) this.text.alignment = anchor;
				
			}
	
			public string GetText() {
	
				return (this.text != null) ? this.text.text : string.Empty;
	
			}
	
			public void SetText(string text) {
	
				if (this.text != null) this.text.text = text;
	
			}
	
			public virtual void SetTextAlpha(float value) {
	
				var color = this.GetTextColor();
				color.a = value;
				this.SetTextColor(color);
	
			}
	
			public virtual void SetTextColor(Color color) {
				
				if (this.text != null) this.text.color = color;
				
			}
			
			public virtual Color GetTextColor() {
	
				if (this.text == null) return Color.white;
	
				return this.text.color;
				
			}
	#endregion

		#if UNITY_EDITOR
		public override void OnValidateEditor() {

			base.OnValidateEditor();

			if (this.gameObject.activeSelf == false) return;

			var buttons = this.GetComponentsInChildren<Button>(true);
			if (buttons.Length == 1) this.button = buttons[0];

			#region macros UI.Windows.Editor.TextComponent 
	/*
	 * This code is auto-generated by Macros Module
	 * Do not change anything
	 */
	var texts = this.GetComponentsInChildren<Text>(true);
				if (texts.Length == 1) this.text = texts[0];
	#endregion

			#region macros UI.Windows.Editor.ImageComponent 
	/*
	 * This code is auto-generated by Macros Module
	 * Do not change anything
	 */
	if (this.image == null) this.image = this.GetComponent<Image>();
				if (this.rawImage == null) this.rawImage = this.GetComponent<RawImage>();
	#endregion

		}
		#endif

	}

}
